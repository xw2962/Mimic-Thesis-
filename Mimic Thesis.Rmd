---
title: "Mimic Thesis"
author: "Amy.Wu"
date: "2024-11-27"
output: github_document
---

# -----------------------------------------------------------
# Setup: Install and Load Required Libraries
# -----------------------------------------------------------
```{r}
options(repos = c(CRAN = "https://cloud.r-project.org"))

# Vector of packages needed for this project
required_pkgs <- c("dplyr", "readr", "ggplot2", "survival", 
                   "randomForest", "stringr")

# Install any packages that aren't already installed, then load them
for (pkg in required_pkgs) {
  if (!require(pkg, character.only = TRUE)) {
    install.packages(pkg, dependencies = TRUE)
    library(pkg, character.only = TRUE)
  }
}
```
# -----------------------------------------------------------
# Aim One: Investigate the relationship between ICU stay duration 
#          and wound healing outcomes in diabetic patients, 
#          identifying key predictors of impaired healing.
# -----------------------------------------------------------

# -----------------------------------------------------------
# Section 1: Load Data from Local CSV Files
# -----------------------------------------------------------
```{r}
# Define file paths (update these paths as necessary)
data_dir <- "/Users/wuxiaoyu/Desktop/9419 Master's Essay/mimic-iv-3.1"
patients_file           <- file.path(data_dir, "hosp", "patients.csv")
icustays_file           <- file.path(data_dir, "icu", "icustays.csv")
diagnoses_icd_file      <- file.path(data_dir, "hosp", "diagnoses_icd.csv")
labevents_file          <- file.path(data_dir, "hosp", "labevents.csv")
procedureevents_file    <- file.path(data_dir, "icu", "procedureevents.csv")
microbiologyevents_file <- file.path(data_dir, "hosp", "microbiologyevents.csv")
d_labitems_file         <- file.path(data_dir, "hosp", "d_labitems.csv")
d_icd_procedures_file   <- file.path(data_dir, "hosp", "d_icd_procedures.csv")

# Read CSV files using readr::read_csv for faster performance
patients            <- read_csv(patients_file)
icustays            <- read_csv(icustays_file)
diagnoses_icd       <- read_csv(diagnoses_icd_file)
labevents           <- read_csv(labevents_file)
procedureevents     <- read_csv(procedureevents_file)
microbiologyevents  <- read_csv(microbiologyevents_file)
d_labitems          <- read_csv(d_labitems_file)
d_icd_procedures    <- read_csv(d_icd_procedures_file)
```
# -----------------------------------------------------------
# Section 2: Define the Diabetic Cohort
# -----------------------------------------------------------
```{r}
# Filter for diabetes-related ICD codes
diabetic_patients <- diagnoses_icd %>%
  filter(str_starts(icd_code, "250") |  # ICD-9: 250.xx
         str_starts(icd_code, "E08") |  # ICD-10: E08
         str_starts(icd_code, "E09") |
         str_starts(icd_code, "E10") |
         str_starts(icd_code, "E11") |
         str_starts(icd_code, "E13")) %>%
  select(subject_id) %>%
  distinct()

# Preview diabetic patients
head(diabetic_patients)

# Extract ICU stays for diabetic patients and keep key columns
diabetic_icu_stays <- icustays %>%
  inner_join(diabetic_patients, by = "subject_id") %>%
  select(subject_id, stay_id, los)
head(diabetic_icu_stays)
```
# -----------------------------------------------------------
# Section 3: Define Wound Healing Outcomes
# -----------------------------------------------------------
```{r}
# (A) Identify Infection-Related Lab Tests
# Get unique lab test descriptions from d_labitems
lab_test_list <- d_labitems %>%
  select(itemid, label) %>%
  distinct()

# Save and inspect the lab test list if needed
write_csv(lab_test_list, "lab_test_list.csv")

# Filter for infection-related terms (e.g., "infection", "WBC", "CRP", "sepsis", "culture")
infection_markers <- lab_test_list %>%
  filter(str_detect(label, regex("infection|WBC|CRP|sepsis|culture", ignore_case = TRUE)))
write_csv(infection_markers, "infection_markers.csv")

# Vector of infection marker item IDs
infection_lab_items <- infection_markers$itemid

# (B) Filter labevents for infection markers and join with ICU stay info
labevents_with_stay_id <- labevents %>%
  inner_join(icustays, by = c("subject_id", "hadm_id")) %>%
  select(subject_id, stay_id, hadm_id, itemid, value, valuenum, flag)

# Filter for infection markers
wound_healing_labs <- labevents_with_stay_id %>%
  filter(itemid %in% infection_lab_items) %>%
  select(subject_id, stay_id, itemid, value, valuenum, flag)
head(wound_healing_labs)

# (C) Identify Wound-Related Procedures
# Extract unique procedure descriptions from d_icd_procedures
procedure_list <- d_icd_procedures %>%
  select(icd_code, long_title) %>%  # Adjust column names if needed
  distinct()
write_csv(procedure_list, "procedure_list.csv")

# Filter for wound-related keywords in procedure descriptions
wound_icd_procedures <- procedure_list %>%
  filter(str_detect(long_title, regex("wound|ulcer|debridement|dressing|skin|abscess", ignore_case = TRUE)))
write_csv(wound_icd_procedures, "wound_icd_procedures.csv")

# Get wound-related ICD codes and filter procedureevents
wound_icd_codes <- wound_icd_procedures$icd_code
wound_procedures <- procedureevents %>%
  filter(itemid %in% wound_icd_codes) %>%  # Assuming itemid contains the procedure codes
  select(subject_id, stay_id, hadm_id, itemid, starttime, value)
write_csv(wound_procedures, "wound_procedures.csv")
head(wound_procedures)

# (D) Extract Wound-Related Microbiology Events
# List and inspect unique specimen types
unique_specimen_types <- microbiologyevents %>%
  select(spec_type_desc) %>%
  distinct()
write_csv(unique_specimen_types, "unique_specimen_types.csv")

# Filter for wound-related specimen types
wound_specimens <- microbiologyevents %>%
  filter(str_detect(spec_type_desc, regex("wound|tissue|abscess|drainage", ignore_case = TRUE)))
write_csv(wound_specimens, "wound_specimens.csv")
head(wound_specimens)

# Further filter for wound-related test names (e.g., "culture", "bacteria", etc.)
wound_tests <- wound_specimens %>%
  filter(str_detect(test_name, regex("culture|bacteria|susceptibility|stain", ignore_case = TRUE))) %>%
  select(subject_id, hadm_id, spec_type_desc, test_name, org_name, ab_name, comments)
write_csv(wound_tests, "wound_tests.csv")
head(wound_tests)

# Extract and save wound test results (comments and results)
wound_results <- wound_tests %>%
  select(subject_id, hadm_id, test_name, org_name, ab_name, comments)
write_csv(wound_results, "wound_results.csv")
head(wound_results)
```

# -----------------------------------------------------------
# Section 4: Combine Data into a Unified Dataset
# -----------------------------------------------------------
```{r}
# Merge diabetic ICU stay data with wound-related labs, procedures, and microbiology results
icu_wound_data <- diabetic_icu_stays %>%
  left_join(wound_healing_labs, by = c("subject_id", "stay_id")) %>%
  left_join(wound_procedures, by = c("subject_id", "stay_id")) %>%
  left_join(wound_results, by = c("subject_id", "hadm_id")) %>%
  mutate(prolonged_stay = if_else(los > 7, 1, 0))  # Flag for prolonged ICU stay (>7 days)

# Check and fix any empty column names by replacing them with a placeholder ("unknown")
icu_wound_data <- icu_wound_data %>%
  rename_with(~ ifelse(. == "", "unknown", .))

# Save the combined dataset (optional)
write_csv(icu_wound_data, "icu_wound_data.csv")
```

# -----------------------------------------------------------
# Section 5: Data Preprocessing and Cleaning
# -----------------------------------------------------------
```{r}
# (A) Remove Duplicates
icu_wound_data <- icu_wound_data %>%
  distinct()

# (B) Consolidate and Clean Value Columns
# Since there is no column named "value" (only value.x and value.y exist),
# we convert those to numeric and then coalesce them into a new "value" column.
icu_wound_data <- icu_wound_data %>%
  mutate(across(c(value.x, value.y), ~ as.numeric(if_else(. %in% c("N/A", ""), NA_character_, as.character(.))))) %>%
  mutate(value = coalesce(value.x, value.y))

# (C) Handle Missing Values in Critical Columns
icu_wound_data <- icu_wound_data %>%
  filter(!is.na(value), !is.na(los))
  
# Optionally, impute any remaining missing 'value' (here we use the mean)
icu_wound_data <- icu_wound_data %>%
  mutate(value = if_else(is.na(value), mean(value, na.rm = TRUE), value))

# (D) Select Only the Necessary Columns
icu_wound_data <- icu_wound_data %>%
  select(subject_id, stay_id, los, value, test_name, org_name, prolonged_stay)

# Verify data structure and summary
str(icu_wound_data)
summary(icu_wound_data)
head(icu_wound_data)
```

# -----------------------------------------------------------
# Section 6: Descriptive Statistics and Visualization
# -----------------------------------------------------------
```{r}
# Summary statistics for ICU length of stay and infection marker values
summary(icu_wound_data$los)
summary(icu_wound_data$value)

# Grouped summary by prolonged stay
prolonged_summary <- icu_wound_data %>%
  group_by(prolonged_stay) %>%
  summarise(
    count = n(),
    mean_los = mean(los, na.rm = TRUE),
    mean_value = mean(value, na.rm = TRUE),
    .groups = "drop"
  )
print(prolonged_summary)

# Plot histogram of ICU length of stay
ggplot(icu_wound_data, aes(x = los)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black") +
  labs(title = "Distribution of ICU Stay Duration",
       x = "Length of Stay (days)",
       y = "Frequency")

# Boxplot of infection marker values by prolonged stay status
ggplot(icu_wound_data, aes(x = factor(prolonged_stay), y = value)) +
  geom_boxplot(fill = "orange") +
  labs(title = "Infection Marker Values by Prolonged ICU Stay",
       x = "Prolonged Stay (0 = No, 1 = Yes)",
       y = "Infection Marker Value")
```

# -----------------------------------------------------------
# Section 7: Regression Analysis
# -----------------------------------------------------------
```{r}
# Linear regression: Predict infection marker value using ICU LOS and prolonged stay flag
reg_model <- lm(value ~ los + prolonged_stay, data = icu_wound_data)
summary(reg_model)

# Plot regression results: Scatter plot with fitted regression line
ggplot(icu_wound_data, aes(x = los, y = value)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", color = "red") +
  labs(title = "Regression: ICU Stay Duration vs Infection Marker Value",
       x = "ICU Length of Stay (days)",
       y = "Infection Marker Value")
```

# -----------------------------------------------------------
# Section 8: Kaplan-Meier Survival Analysis
# -----------------------------------------------------------
```{r}
# Here we simulate wound healing times.
# Replace this simulation with actual healing data if available.
set.seed(123)  # For reproducibility
icu_wound_data <- icu_wound_data %>%
  mutate(
    healing_time = los + sample(1:5, n(), replace = TRUE),
    healed = if_else(value < 5, 1, 0)  # Define healing based on infection marker threshold
  )

# Fit Kaplan-Meier survival model
km_fit <- survfit(Surv(healing_time, healed) ~ prolonged_stay, data = icu_wound_data)

# Plot Kaplan-Meier survival curves
plot(km_fit, col = c("blue", "red"), lwd = 2,
     xlab = "Time to Wound Healing (days)",
     ylab = "Survival Probability",
     main = "Kaplan-Meier Curve: Time to Wound Healing")
legend("topright", legend = c("Short ICU Stay", "Prolonged ICU Stay"),
       col = c("blue", "red"), lwd = 2)
```

# -----------------------------------------------------------
# Section 9: Random Forest Feature Importance
# -----------------------------------------------------------
```{r}
# Prepare data for random forest analysis by selecting relevant variables and removing NAs
rf_data <- icu_wound_data %>%
  select(value, los, prolonged_stay) %>%
  na.omit()

# Train the random forest model (predicting infection marker value)
rf_model <- randomForest(
  value ~ los + prolonged_stay,
  data = rf_data,
  importance = TRUE,
  ntree = 500
)

# Print and plot feature importance
print(importance(rf_model))
varImpPlot(rf_model)
```
# -----------------------------------------------------------
# Section 10: Identifying Key Predictors of Impaired Healing
# -----------------------------------------------------------
```{r section10, echo=TRUE, message=FALSE}
# Examine the range of infection marker values
icu_wound_data %>% 
  summarise(
    min_value = min(value, na.rm = TRUE),
    max_value = max(value, na.rm = TRUE)
  )
# Expected output: min_value = 0, max_value = 961

# Create a binary outcome for impaired healing using a threshold of 100.
# Here, values >= 100 are considered indicative of impaired healing.
icu_wound_data <- icu_wound_data %>%
  mutate(impaired_healing = if_else(value >= 100, 1, 0))

# Check the distribution of the new outcome variable
print(table(icu_wound_data$impaired_healing))

# Fit a logistic regression model to assess predictors of impaired healing
logit_model <- glm(impaired_healing ~ los + prolonged_stay, 
                   data = icu_wound_data, 
                   family = binomial)

# Display the summary of the logistic regression model
summary(logit_model)

# Calculate odds ratios and 95% confidence intervals for the predictors
exp_coef <- exp(coef(logit_model))
conf_int <- exp(confint(logit_model))
odds_ratios <- data.frame(
  Estimate = exp_coef, 
  Lower_CI = conf_int[, 1], 
  Upper_CI = conf_int[, 2]
)
print(odds_ratios)
```

# -----------------------------------------------------------
# Section 11: Cox Proportional Hazards Model for Time to Healing
# -----------------------------------------------------------
```{r section11, echo=TRUE, message=FALSE}
# Ensure the survival package is loaded
library(survival)

# Fit the Cox proportional hazards model using healing time and the event indicator (healed)
cox_model <- coxph(Surv(healing_time, healed) ~ los + prolonged_stay, 
                   data = icu_wound_data)

# Summarize the Cox model to review hazard ratios (HR) and p-values
summary(cox_model)
```